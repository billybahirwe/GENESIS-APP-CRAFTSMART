extends ../layout.pug

block content
  .container
    h2.form-title Make Payment for "#{job.title}"

    .job-details-container
      p.job-info-item
        strong Job ID:
        | #{job._id}
      p.job-info-item
        strong Amount Due:
        | UGX #{job.budget}
      p.job-info-item
        strong Craftsman:
        | #{craftsman.name}
    
    // âœ… System fee info
    .alert.alert-info.mt-3
      p.mb-0 A 10% system fee (UGX #{(job.budget * 0.10).toLocaleString('en-UG', { useGrouping: true })}) will be applied.
      p.mb-0 The craftsman will receive a net amount of <strong>UGX #{(job.budget * 0.90).toLocaleString('en-UG', { useGrouping: true })}</strong> upon job completion.

    if message
      .alert.alert-danger #{message}

    form#paymentForm
      input(type='hidden' name='jobId' value=job._id)
      input(type='hidden' name='amount' value=job.budget)
      input(type='hidden' name='craftsmanId' value=craftsman._id)

      // âœ… Craftsmanâ€™s number auto-filled by backend
      .form-group
        label(for='mobile_number') Craftsmanâ€™s Mobile Money Number
        input.form-control(
          type='tel'
          id='mobile_number'
          name='mobile_number'
          value=mobileNumber
          readonly
        )

      // âœ… Network passed automatically
      input(type='hidden' id='network' name='network' value=network)

      button.btn.btn-primary(type='submit') Pay UGX #{job.budget}

    .form-links
      a.btn.btn-secondary(href=`/employer/applications/${job._id}`) Back to Applications

  // ðŸ‘‡ Client-side Socket.IO integration
  script(src="/socket.io/socket.io.js")
  script.
    const socket = io();
    socket.emit("join", "#{user._id}");

    document.getElementById("paymentForm").addEventListener("submit", function(e) {
      e.preventDefault();

      const jobId = this.jobId.value;
      const amount = this.amount.value;
      const mobile_number = this.mobile_number.value;
      const network = this.network.value;

      const fee = amount * 0.10;
      const craftsmanAmount = amount * 0.90;

      socket.emit("initiatePayment", {
        jobId,
        amount,
        mobile_number,
        network,
        userId: "#{user._id}",
        fee,
        craftsmanAmount
      });
    });

    socket.on("paymentLink", (data) => {
      if (data.success && data.link) {
        window.location.href = data.link;
      } else {
        alert(data.message || "Payment initiation failed");
        console.error(data);
      }
    });
