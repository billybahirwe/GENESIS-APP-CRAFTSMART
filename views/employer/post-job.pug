extends ../layout

block content
  .container
    .page-header
      h1.page-title Post a New Job
      p.page-subtitle Describe your project to attract the right craftsmen

    .form-container
      form.job-form(action="/employer/post-job", method="POST", enctype="multipart/form-data")
        .form-group
          label(for="title") Job Title
          input.form-control(type="text", id="title", name="title", required, placeholder="e.g., Bathroom Renovation")
        
        .form-group
          label(for="category") Category
          select.form-control(id="category", name="category", required)
            option(value="") Select category
            option(value="Plumbing") Plumbing
            option(value="Electrical") Electrical
            option(value="Carpentry") Carpentry
            option(value="Painting") Painting
            option(value="Roofing") Roofing
            option(value="Flooring") Flooring
            option(value="HVAC") HVAC
            option(value="General") General Maintenance
        
        .form-group
          label(for="description") Job Description
          textarea.form-control(id="description", name="description", rows="5", required, placeholder="Provide detailed information about your project...")
        
        .form-group
          label(for="location") Location
          input.form-control(type="text", id="location", name="location", required, placeholder="City, State")
        
        .form-group
          label(for="budget") Budget (UGX)
          input.form-control(type="number", id="budget", name="budget", required, min="0", step="0.01", placeholder="e.g., 500000")
          // Fee notification
          .fee-notification#fee-notification(style="display: none;")

        .form-group
          label(for="images") Project Images (Optional)
          #images-container
            .image-upload-wrapper.mb-2
              input.form-control(type="file", name="images", accept="image/*")
          button.btn.btn-secondary.btn-sm.mt-2#add-image-btn(type="button") Add Another Image
          small.form-text.text-muted.mt-2 Upload up to 10 images to help craftsmen understand your project
        
        .form-actions
          button.btn.btn-primary(type="submit") Post Job
          a.btn.btn-secondary(href="/employer/dashboard") Cancel

block scripts
  script.
    document.addEventListener("DOMContentLoaded", function () {
      const container = document.getElementById("images-container");
      const addBtn = document.getElementById("add-image-btn");

      const firstInputWrapper = container.querySelector(".image-upload-wrapper");
      if (firstInputWrapper) addDeleteButton(firstInputWrapper);

      addBtn.addEventListener("click", function () {
        const inputs = container.querySelectorAll("input[type='file']");
        if (inputs.length >= 10) {
          alert("You can only upload up to 10 images.");
          return;
        }

        const newWrapper = document.createElement("div");
        newWrapper.classList.add("image-upload-wrapper", "mb-2");
        
        const newInput = document.createElement("input");
        newInput.type = "file";
        newInput.name = "images";
        newInput.accept = "image/*";
        newInput.classList.add("form-control");
        
        newWrapper.appendChild(newInput);
        addDeleteButton(newWrapper);
        container.appendChild(newWrapper);
      });

      function addDeleteButton(wrapper) {
        const deleteBtn = document.createElement("button");
        deleteBtn.type = "button";
        deleteBtn.textContent = "Delete";
        deleteBtn.classList.add("btn", "btn-danger", "btn-sm", "ms-2");
        deleteBtn.addEventListener("click", function () {
          wrapper.remove();
        });
        wrapper.appendChild(deleteBtn);
      }

      // --- System Fee Notification ---
      const budgetInput = document.getElementById("budget");
      const feeNotification = document.getElementById("fee-notification");
      const feePercentage = 0.10;
      const minFee = 1000;

      budgetInput.addEventListener("input", function() {
        const budget = parseFloat(this.value);
        let message = '';
        
        if (isNaN(budget) || budget <= 0) {
          feeNotification.style.display = "none";
          return;
        }

        // Calculate fee: 10% or minimum UGX 1,000, whichever is greater.
        const feeAmount = Math.max(budget * feePercentage, minFee);
        const craftsmanReceives = budget - feeAmount;

        if (craftsmanReceives < 0) {
          message = `
            <p class="mt-2" style="color: red;">
              <strong>Alert:</strong> The budget is too low. The craftsman's share is less than the system fee of UGX ${feeAmount.toLocaleString('en-UG')}.
            </p>
          `;
        } else {
          message = `
            <p class="mt-2 text-info">
              <strong>Note:</strong> A system fee of <strong>UGX ${feeAmount.toLocaleString('en-UG')}</strong> will be deducted from the budget.
              The craftsman will receive <strong>UGX ${craftsmanReceives.toLocaleString('en-UG')}</strong>.
            </p>
          `;
        }
        
        feeNotification.style.display = "block";
        feeNotification.innerHTML = message;
      });
    });