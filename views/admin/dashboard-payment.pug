//- views/admin/dashboard-payment.pug
extends ../layout

block append head
  // Tailwind CSS
  link(rel="stylesheet", href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css")
  // Font Awesome for icons
  link(rel="stylesheet", href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css")

  style.
    .gradient-bg {
      background: linear-gradient(to right, #2563EB, #6366F1);
    }
    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    .status-badge.bg-green-100 { background-color: #d1fae5; color: #065f46; }
    .status-badge.bg-red-100 { background-color: #fee2e2; color: #991b1b; }
    .status-badge.bg-yellow-100 { background-color: #fef3c7; color: #92400e; }
    .status-badge.bg-blue-100 { background-color: #dbeafe; color: #1e40af; }
    .status-badge.bg-gray-100 { background-color: #f3f4f6; color: #374151; }

block content
  .min-h-screen.bg-gray-100.py-8.px-4
    .max-w-7xl.mx-auto
      .bg-white.rounded-2xl.shadow-lg.overflow-hidden
        // Header
        div(class="gradient-bg px-6 py-8 text-white text-center sm:text-left")
          div(class="flex flex-col sm:flex-row items-center justify-between")
            h1(class="text-2xl font-bold mb-2 sm:mb-0") Payment Transactions
            .text-right
              p(class="text-blue-100") Manage all your payments
              p(class="text-xs text-blue-200 mt-1") 
                | Data as of #{new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}

        // Transaction List
        .p-6.overflow-x-auto
          if transactions && transactions.length
            .min-w-full.inline-block.align-middle
              .overflow-hidden.border.border-gray-200.rounded-lg.shadow-sm
                table.min-w-full.divide-y.divide-gray-200
                  thead.bg-gray-50
                    tr
                      th.px-6.py-3.text-left.text-xs.font-medium.text-gray-500.uppercase.tracking-wider Case ID
                      th.px-6.py-3.text-left.text-xs.font-medium.text-gray-500.uppercase.tracking-wider Amount
                      th.px-6.py-3.text-left.text-xs.font-medium.text-gray-500.uppercase.tracking-wider Status
                      th.px-6.py-3.text-left.text-xs.font-medium.text-gray-500.uppercase.tracking-wider Initiated
                  tbody.bg-white.divide-y.divide-gray-200
                    each transaction in transactions
                      - var caseId = transaction.case_id || 'N/A'
                      - var createdDate = transaction.created_at ? new Date(transaction.created_at) : null
                      - var formattedDate = (createdDate && !isNaN(createdDate.getTime())) ? createdDate.toLocaleString('en-UG', { year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' }) : 'N/A'
                      tr
                        td.px-6.py-4.whitespace-nowrap.text-sm.font-medium.text-gray-900 #{caseId}
                        td.px-6.py-4.whitespace-nowrap.text-sm.text-gray-500 UGX #{transaction.total_amount ? transaction.total_amount.toLocaleString('en-UG') : 'N/A'}
                        td.px-6.py-4.whitespace-nowrap.text-sm
                          case transaction.status
                            when 'PENDING'
                              .status-badge.bg-gray-100.text-gray-800
                                i.fas.fa-clock.mr-1
                                | Pending
                            when 'PAYMENT_REQUESTED'
                              .status-badge.bg-blue-100.text-blue-800
                                i.fas.fa-mobile-alt.mr-1
                                | Requested
                            when 'SUCCESSFUL'
                              .status-badge.bg-green-100.text-green-800
                                i.fas.fa-check-circle.mr-1
                                | Received
                            when 'PAYMENT_FAILED'
                              .status-badge.bg-red-100.text-red-800
                                i.fas.fa-times-circle.mr-1
                                | Failed
                            when 'DISBURSEMENT_INITIATED'
                              .status-badge.bg-yellow-100.text-yellow-800
                                i.fas.fa-arrow-right.mr-1
                                | Disbursement
                            when 'COMPLETED'
                              .status-badge.bg-green-100.text-green-800
                                i.fas.fa-check-circle.mr-1
                                | Completed
                            when 'DISBURSEMENT_FAILED'
                              .status-badge.bg-red-100.text-red-800
                                i.fas.fa-exclamation-triangle.mr-1
                                | Disbursement Failed
                            default
                              .status-badge.bg-gray-100.text-gray-800= transaction.status
                        td.px-6.py-4.whitespace-nowrap.text-sm.text-gray-500 #{formattedDate}
          else
            .text-center.p-8.text-gray-500
              p.text-lg.font-semibold No payments found.
              p.text-sm Start processing new payments to see them here.

block scripts
  script.
    // Helper function to format currency safely
    function formatCurrency(amount) {
      if (!amount && amount !== 0) return 'N/A';
      return `UGX ${new Intl.NumberFormat('en-UG').format(amount)}`;
    }

    // Helper function to format date safely
    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      return !isNaN(date.getTime()) ? date.toLocaleString('en-UG', { year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' }) : 'N/A';
    }
