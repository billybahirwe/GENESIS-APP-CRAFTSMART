extends ../layout

block content
  .row
    .col-12
      .d-flex.justify-content-between.align-items-center.mb-4
        h1.mb-0
          i.bi.bi-shield-x.me-2
          | Blacklist Management
        button.btn.btn-primary(data-bs-toggle="modal" data-bs-target="#addBlacklistModal")
          i.bi.bi-plus-circle.me-2
          | Add to Blacklist

  .row
    .col-12
      .card.shadow-sm
        .card-header.bg-dark.text-white
          h5.mb-0
            i.bi.bi-list.me-2
            | Blacklisted Users (#{blacklist.length})
        .card-body.p-0
          if blacklist.length === 0
            .text-center.py-5#no-users
              i.bi.bi-shield-check.display-1.text-success
              h4.mt-3 No blacklisted users
              p.text-muted The blacklist is currently empty.
          else
            .table-responsive
              table.table.table-striped.table-hover.mb-0#blacklist-table
                thead.table-dark
                  tr
                    th Name
                    th Mobile
                    th Reason
                    th Added Date
                    th Actions
                tbody
                  each user in blacklist
                    tr(id=`blacklist-${user._id}`)
                      td
                        strong #{user.name}
                      td
                        code #{user.mobile}
                      td
                        span.badge.bg-warning.text-dark #{user.reason}
                      td
                        small.text-muted #{formatDate(user.addedAt)}
                      td
                        button.btn.btn-danger.btn-sm(
                          type="button"
                          data-action="remove-blacklist"
                          data-id=user._id
                        )
                          i.bi.bi-trash.me-1
                          | Remove

  // Add to Blacklist Modal
  .modal.fade#addBlacklistModal(tabindex="-1")
    .modal-dialog
      .modal-content
        form#addBlacklistForm
          .modal-header.bg-primary.text-white
            h5.modal-title
              i.bi.bi-shield-x.me-2
              | Add User to Blacklist
            button.btn-close.btn-close-white(type="button" data-bs-dismiss="modal")
          .modal-body
            .mb-3
              label.form-label(for="name") Full Name
              input#name.form-control(type="text" required placeholder="Enter full name")
            .mb-3
              label.form-label(for="mobile") Mobile Number
              input#mobile.form-control(type="tel" required placeholder="Enter mobile number")
            .mb-3
              label.form-label(for="reason") Reason for Blacklisting
              select#reason.form-select(required)
                option(value="") Select a reason...
                option(value="Poor Performance") Poor Performance
                option(value="Unprofessional Behavior") Unprofessional Behavior
                option(value="Safety Violations") Safety Violations
                option(value="Fraud/Scam") Fraud/Scam
                option(value="Harassment") Harassment
                option(value="Other") Other
          .modal-footer
            button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Cancel
            button.btn.btn-danger(type="submit")
              i.bi.bi-shield-x.me-2
              | Add to Blacklist

block scripts
  script.
    document.addEventListener('DOMContentLoaded', () => {
      console.log("✅ blacklist.pug JS loaded");

      // Remove user dynamically
      document.addEventListener('click', async (e) => {
        const btn = e.target.closest('button[data-action="remove-blacklist"]');
        if (!btn) return;
        const id = btn.dataset.id;
        if (!confirm("Are you sure you want to remove this user from the blacklist?")) return;

        try {
          const res = await fetch(`/admin/blacklist/${id}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin'
          });
          const data = await res.json();
          if (data.message) {
            const row = document.getElementById(`blacklist-${id}`);
            if (row) row.remove();

            // If no more rows, show "no users" message
            const tbody = document.querySelector('#blacklist-table tbody');
            if (!tbody || tbody.children.length === 0) {
              document.getElementById('no-users').classList.remove('d-none');
            }

            alert(data.message);
          }
        } catch (err) {
          console.error(err);
          alert("Error removing user from blacklist");
        }
      });

      // Add user dynamically
      const addForm = document.getElementById('addBlacklistForm');
      addForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = {
          name: document.getElementById('name').value.trim(),
          mobile: document.getElementById('mobile').value.trim(),
          reason: document.getElementById('reason').value
        };

        if (!formData.name || !formData.mobile || !formData.reason) {
          alert("All fields are required");
          return;
        }

        try {
          const res = await fetch('/admin/blacklist', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify(formData)
          });
          const data = await res.json();

          if (data.success) {
            // Remove "no users" message if it exists
            const noUsersDiv = document.getElementById('no-users');
            if (noUsersDiv) noUsersDiv.classList.add('d-none');

            // If table doesn't exist yet, create it
            let table = document.getElementById('blacklist-table');
            if (!table) {
              const cardBody = document.querySelector('.card-body');
              table = document.createElement('table');
              table.id = 'blacklist-table';
              table.className = 'table table-striped table-hover mb-0';
              table.innerHTML = `
                <thead class="table-dark">
                  <tr>
                    <th>Name</th>
                    <th>Mobile</th>
                    <th>Reason</th>
                    <th>Added Date</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              `;
              cardBody.innerHTML = '';
              cardBody.appendChild(table);
            }

            const tbody = table.querySelector('tbody');
            const tr = document.createElement('tr');
            tr.id = `blacklist-${data.user._id}`;
            tr.innerHTML = `
              <td><strong>${data.user.name}</strong></td>
              <td><code>${data.user.mobile}</code></td>
              <td><span class="badge bg-warning text-dark">${data.user.reason}</span></td>
              <td><small class="text-muted">${new Date(data.user.addedAt).toLocaleString()}</small></td>
              <td>
                <button class="btn btn-danger btn-sm" type="button" data-action="remove-blacklist" data-id="${data.user._id}">
                  <i class="bi bi-trash me-1"></i> Remove
                </button>
              </td>
            `;
            tbody.prepend(tr);

            addForm.reset();
            const modal = bootstrap.Modal.getInstance(document.getElementById('addBlacklistModal'));
            modal.hide();
            alert("✅ User added to blacklist successfully");
          } else {
            alert(data.message || "Failed to add user");
          }
        } catch (err) {
          console.error(err);
          alert("⚠️ Network or server error adding user.");
        }
      });
    });








//- extends ../layout

//- block content
//-   .container
//-     .page-header
//-       h1 Blacklist Management
//-       p Manage banned users

//-     // Add button
//-     .blacklist-actions.mb-3
//-       button.btn.btn-primary(type="button", id="toggleAddBtn") Add to Blacklist

//-     // Add form (hidden by default)
//-     .add-form-container#add-form.hidden
//-       form(action="/admin/blacklist", method="POST", id="blacklistForm")
//-         .form-group.mb-2
//-           input.form-control(type="text", name="name", required, placeholder="Name")
//-         .form-group.mb-2
//-           input.form-control(type="tel", name="mobile", required, placeholder="Mobile")
//-         .form-group.mb-2
//-           textarea.form-control(name="reason", required, rows="3", placeholder="Reason")
//-         .form-actions.mt-2
//-           button.btn.btn-success(type="submit") Add
//-           button.btn.btn-secondary(type="button", id="cancelAddBtn") Cancel

//-     hr

//-     // Blacklist entries
//-     .blacklist-container
//-       if blacklist.length
//-         each entry in blacklist
//-           .card.mb-3.p-3.shadow-sm
//-             h5= entry.name
//-             p.mb-1 
//-               strong Mobile: 
//-               |  #{entry.mobile}
//-             p.mb-1 
//-               strong Reason: 
//-               |  #{entry.reason}
//-             p.mb-1 
//-               strong Added: 
//-               |  #{entry.addedAt ? formatDate(entry.addedAt) : 'N/A'}
//-             // Remove button with safe _id
//-             button.btn.btn-danger.btn-sm.remove-btn(
//-               type="button", 
//-               data-id=entry._id ? entry._id : ''
//-             ) Remove
//-       else
//-         p.text-muted No blacklisted users.

//-     // Remove confirmation modal
//-     #removeModal.modal.fade(tabindex="-1")
//-       .modal-dialog
//-         .modal-content
//-           .modal-header
//-             h5.modal-title Remove from Blacklist
//-             button.btn-close(type="button", data-bs-dismiss="modal")
//-           .modal-body
//-             p Are you sure you want to remove this user?
//-           .modal-footer
//-             button.btn.btn-secondary(type="button", data-bs-dismiss="modal") Cancel
//-             button.btn.btn-danger#confirmRemove(type="button") Confirm

//- block append scripts
//-   script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js")
//-   script.
//-     document.addEventListener("DOMContentLoaded", function() {
//-       const addForm = document.getElementById("add-form");
//-       const toggleBtn = document.getElementById("toggleAddBtn");
//-       const cancelBtn = document.getElementById("cancelAddBtn");

//-       // Toggle Add Form
//-       toggleBtn.addEventListener("click", () => addForm.classList.toggle("hidden"));
//-       cancelBtn.addEventListener("click", () => addForm.classList.add("hidden"));

//-       // Optional: debug form submission
//-       const form = document.getElementById("blacklistForm");
//-       if (form) {
//-         form.addEventListener("submit", (e) => {
//-           console.log("Form submitted", {
//-             name: form.name.value,
//-             mobile: form.mobile.value,
//-             reason: form.reason.value
//-           });
//-         });
//-       }

//-       // Remove modal logic
//-       let currentEntryId = null;
//-       const removeModalEl = document.getElementById("removeModal");
//-       const removeModal = new bootstrap.Modal(removeModalEl);

//-       // Event delegation for remove buttons with debug log
//-       const blacklistContainer = document.querySelector(".blacklist-container");
//-       if (blacklistContainer) {
//-         blacklistContainer.addEventListener("click", function(e) {
//-           if (e.target && e.target.classList.contains("remove-btn")) {
//-             console.log("Remove button clicked:", e.target.dataset.id);
//-             currentEntryId = e.target.dataset.id;
//-             removeModal.show();
//-           }
//-         });
//-       }

//-       // Confirm removal
//-       const confirmBtn = document.getElementById("confirmRemove");
//-       if (confirmBtn) {
//-         confirmBtn.addEventListener("click", async () => {
//-           if (!currentEntryId) return;

//-           try {
//-             const res = await fetch(`/admin/blacklist/${currentEntryId}`, { method: 'DELETE' });
//-             if (res.ok) {
//-               // Remove the card from the DOM
//-               const btn = document.querySelector(`.remove-btn[data-id="${currentEntryId}"]`);
//-               if (btn) btn.closest(".card").remove();
//-               removeModal.hide();
//-               currentEntryId = null;
//-             } else {
//-               alert("Failed to remove user");
//-             }
//-           } catch (err) {
//-             console.error("Error removing user:", err);
//-             alert("Error removing user");
//-           }
//-         });
//-       }
//-     });

//-   style.
//-     .hidden { display: none; }
