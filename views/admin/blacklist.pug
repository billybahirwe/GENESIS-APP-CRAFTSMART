extends ../layout

block content
  .container
    .page-header
      h1.page-title Blacklist Management
      p.page-subtitle Manage banned users and add new entries
    
    .blacklist-actions
      button.btn.btn-primary(onclick="toggleAddForm()") Add to Blacklist
    
    // The form is hidden by default using a CSS class.
    .add-form-container(id="add-form", class="hidden")
      .form-card
        h3 Add User to Blacklist
        form.blacklist-form(action="/admin/blacklist", method="POST")
          .form-group
            label(for="name") Name
            input.form-control(type="text", id="name", name="name", required)
          .form-group
            label(for="mobile") Mobile Number
            input.form-control(type="tel", id="mobile", name="mobile", required)
          .form-group
            label(for="reason") Reason for Blacklisting
            textarea.form-control(id="reason", name="reason", rows="3", required, placeholder="Describe the reason for blacklisting this user...")
          .form-actions
            button.btn.btn-danger(type="submit") Add to Blacklist
            button.btn.btn-secondary(type="button", onclick="toggleAddForm()") Cancel
    
    .blacklist-container
      if blacklist.length > 0
        .blacklist-grid
          each entry in blacklist
            .blacklist-card
              .blacklist-info
                h3.blacklist-name= entry.name
                p.blacklist-mobile Mobile: #{entry.mobile}
                p.blacklist-reason= entry.reason
                .blacklist-meta
                  // This line handles potential missing dates to prevent errors.
                  span.blacklist-date Added: #{entry.addedAt ? entry.addedAt.toLocaleDateString() : 'N/A'}
              .blacklist-actions
                // This button now triggers the password prompt when clicked.
                button.btn.btn-danger.btn-sm(onclick=`removeFromBlacklist('${entry._id}')`) Remove
      else
        .empty-state
          .empty-icon ðŸŽ‰
          h3 No Blacklisted Users
          p The platform is currently free of banned users.

block scripts
  script.
    // This function toggles the form's visibility.
    function toggleAddForm() {
      const form = document.getElementById('add-form');
      form.classList.toggle('hidden');
    }
    
    // This function handles the password and sends it to the server.
    async function removeFromBlacklist(id) {
      if (confirm('Are you sure you want to remove this user from the blacklist?')) {
        const password = prompt("Please enter the admin password to confirm deletion:");
        if (!password) {
          return; 
        }

        try {
          const response = await fetch(`/admin/blacklist/${id}`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ password })
          });
          
          if (response.ok) {
            location.reload();
          } else if (response.status === 401) {
            alert('Incorrect password. Deletion failed.');
          } else {
            alert('Error removing user from blacklist');
          }
        } catch (error) {
          alert('Error removing user from blacklist');
        }
      }
    }