extends ../layout

block append head
  link(rel='stylesheet', href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css')
  style.
    a { text-decoration: none; color: inherit; }

block content
  .container
    .dashboard-header
      h1.dashboard-title Admin Dashboard
      p.dashboard-subtitle Manage platform users, jobs, and payments

    // --- Stats Section ---
    .dashboard-stats(style="display:flex; flex-wrap:wrap; gap:1rem;")
      // Total Users Card
      a.stat-card(href="#usersSection", style="flex:1 1 200px; padding:1rem; border:1px solid #ddd; border-radius:8px;")
        .stat-icon
          i.fas.fa-users
        .stat-info
          .stat-number= Array.isArray(totalUsers) ? totalUsers.length : totalUsers || 0
          .stat-label Total Users

      // Total Jobs Card
      a.stat-card(href="#jobsSection", style="flex:1 1 200px; padding:1rem; border:1px solid #ddd; border-radius:8px;")
        .stat-icon
          i.fas.fa-clipboard-list
        .stat-info
          .stat-number= Array.isArray(totalJobs) ? totalJobs.length : totalJobs || 0
          .stat-label Total Jobs

      // Pending Payments Card
      a.stat-card(href="#paymentSection", style="flex:1 1 200px; padding:1rem; border:1px solid #ddd; border-radius:8px;")
        .stat-icon
          i.fas.fa-money-check-alt
        .stat-info
          .stat-number= Array.isArray(pendingPayments) ? pendingPayments.length : 0
          .stat-label Pending Payments

      // Pending Craftsmen Approvals Card
      a.stat-card(href="#craftsmenSection", style="flex:1 1 200px; padding:1rem; border:1px solid #ddd; border-radius:8px;")
        .stat-icon
          i.fas.fa-hourglass-half
        .stat-info
          .stat-number= Array.isArray(pendingCraftsmen) ? pendingCraftsmen.length : 0
          .stat-label Pending Approvals

    // --- Pending Craftsman Approvals Section ---
    .admin-section(id="craftsmenSection")
      h2 Pending Craftsman Approvals
      if pendingCraftsmen && pendingCraftsmen.length > 0
        .approval-list(style="display:flex; flex-wrap:wrap; gap:1rem;")
          each craftsman in pendingCraftsmen
            .approval-card(style="flex:1 1 300px; padding:1rem; border:1px solid #ddd; border-radius:8px;")
              .approval-info
                h3= craftsman.name
                p Email: #{craftsman.email}
                p Mobile: #{craftsman.mobile}
                p Location: #{craftsman.location.city}, #{craftsman.location.district}, #{craftsman.location.region}
                if craftsman.skills && craftsman.skills.length > 0
                  p Skills: #{craftsman.skills.join(', ')}
                p Experience: #{craftsman.experience} years
              .approval-actions(style="margin-top:0.5rem; display:flex; gap:0.5rem; flex-wrap:wrap;")
                form.inline-form(action=`/admin/approve-craftsman/${craftsman._id}`, method="POST")
                  button.btn.btn-success.btn-sm(type="submit") Approve
                form.inline-form(action=`/admin/reject-craftsman/${craftsman._id}`, method="POST")
                  button.btn.btn-danger.btn-sm(type="submit") Reject
      else
        .empty-state
          .empty-icon
            i.fas.fa-check-circle
          h3 No Pending Approvals
          p All craftsman profiles are up to date

    // --- Platform Management Section ---
    .admin-section(id="platformSection")
      h2 Platform Management
      .management-actions(style="display:flex; flex-wrap:wrap; gap:1rem;")
        a.btn.btn-secondary(href="/admin/craftsmen") View All Craftsmen
        a.btn.btn-secondary(href="/admin/employers") View All Employers
        a.btn.btn-primary(href="/admin/blacklist") Manage Blacklist
        a.btn.btn-secondary(href="/admin/reports-message") View Reports
        a.btn.btn-secondary(href="/admin/export-data") Export Data
        a.btn.btn-secondary(href="/admin/dashboard-payment") Manage Payments

    // --- Payment Controls Section ---
    .admin-section(id="paymentSection")
      h2 Payment Controls
      p Quickly manage escrow payments, withdraw fees, and emergency confirmations

      .payment-cards(style="display:flex; flex-wrap:wrap; gap:1rem;")
        // Platform Summary Buttons
        .payment-card(style="flex:1 1 300px; padding:1rem; border:1px solid #ddd; border-radius:8px;")
          h4 Platform Summary
          a.btn(style="background-color:#0ea5e9; color:white; margin-bottom:0.5rem; width:100%;", href=`/job/admin/summary?adminId=${adminId}`) View Platform Balance Summary
          a.btn(style="background-color:#facc15; color:black; margin-bottom:0.5rem; width:100%;", href=`/job/admin/escrow?adminId=${adminId}`) View Jobs in Escrow
          a.btn(style="background-color:#16a34a; color:white; margin-bottom:0.5rem; width:100%;", href=`/job/admin/completed?adminId=${adminId}`) View Completed Payouts
          a.btn(style="background-color:#dc2626; color:white; margin-bottom:0.5rem; width:100%;", href=`/job/admin/actions?adminId=${adminId}`) View Admin Action Logs

        // Withdraw Platform Fees
        .payment-card(style="flex:1 1 300px; padding:1rem; border:1px solid #ddd; border-radius:8px;")
          h4 Withdraw Platform Fees
          form(action="/job/admin/withdraw", method="POST")
            input(type="hidden", name="adminId", value=adminId)
            .form-group
              label(for="amount") Amount to Withdraw
              input.form-control(type="number", name="amount", placeholder="Enter Amount", required)
            .form-group
              label(for="phoneNumber") MoMo Phone Number
              input.form-control(type="text", name="phoneNumber", placeholder="Enter Phone Number", required)
            button.btn.btn-primary.btn-block(type="submit") Withdraw Fees

    // --- Jobs in Escrow Section ---
    .admin-section(id="jobsSection")
      h2 Jobs in Escrow
      if escrowJobs && escrowJobs.length > 0
        table.table.table-striped
          thead
            tr
              th Job Title
              th Employer
              th Craftsman
              th Budget
              th Status
              th Action
          tbody
            each job in escrowJobs
              tr
                td= job.title
                td= job.employer && job.employer.name ? job.employer.name : 'N/A'
                td= job.craftsman && job.craftsman.name ? job.craftsman.name : 'N/A'
                td UGX #{job.budget.toLocaleString('en-UG', { useGrouping: true })}
                td= job.status
                td
                  form(action=`/job/${job._id}/admin-confirm`, method="POST", onsubmit="return confirm('Are you sure you want to emergency confirm this payout?');")
                    input(type="hidden", name="adminId", value=adminId)
                    button.btn(style="background-color:#dc2626; color:white;", type="submit") Emergency Confirm
      else
        .empty-state
          .empty-icon
            i.fas.fa-check-circle
          h3 No Jobs in Escrow
          p All escrow funds have been managed
