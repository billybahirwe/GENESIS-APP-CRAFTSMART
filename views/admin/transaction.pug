extends ../layout

block append head
  // Tailwind CSS
  link(rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css")
  // Font Awesome for icons
  link(rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css")

  style.
    .gradient-bg {
      background: linear-gradient(to right, #2563EB, #6366F1);
    }
    .card-shadow {
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
    }
    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    .btn-primary {
      background-color: #3b82f6;
      color: white;
      transition: background-color 0.3s ease;
    }
    .btn-primary:hover {
      background-color: #2563eb;
    }

block content
  .min-h-screen.bg-gray-50.py-8.px-4
    .max-w-4xl.mx-auto
      .bg-white.rounded-2xl.card-shadow.overflow-hidden
        // Header
        .gradient-bg.px-6.py-8.text-white
          .flex.items-center.justify-between
            div
              h1.text-2xl.font-bold Transaction Details
              p.text-blue-100 #{transaction.transaction_id}
            .text-right
              case transaction.status
                when 'PENDING'
                  .status-badge.bg-gray-100.text-gray-800
                    i.fas.fa-clock.mr-1
                    | Pending
                when 'PAYMENT_REQUESTED'
                  .status-badge.bg-blue-100.text-blue-800
                    i.fas.fa-mobile-alt.mr-1
                    | Payment Requested
                when 'SUCCESSFUL'
                  .status-badge.bg-green-100.text-green-800
                    i.fas.fa-check-circle.mr-1
                    | Payment Received
                when 'PAYMENT_FAILED'
                  .status-badge.bg-red-100.text-red-800
                    i.fas.fa-times-circle.mr-1
                    | Payment Failed
                when 'DISBURSEMENT_INITIATED'
                  .status-badge.bg-yellow-100.text-yellow-800
                    i.fas.fa-arrow-right.mr-1
                    | Disbursement Initiated
                when 'COMPLETED'
                  .status-badge.bg-green-100.text-green-800
                    i.fas.fa-check-circle.mr-1
                    | Completed
                when 'DISBURSEMENT_FAILED'
                  .status-badge.bg-red-100.text-red-800
                    i.fas.fa-exclamation-triangle.mr-1
                    | Disbursement Failed
                default
                  .status-badge.bg-gray-100.text-gray-800= transaction.status

        .p-6
          // Transaction Information
          .grid.grid-cols-1.lg:grid-cols-2.gap-8.mb-8
            // Basic Details
            .bg-gray-50.rounded-lg.p-6
              h2.text-lg.font-semibold.text-gray-800.mb-4
                i.fas.fa-info-circle.mr-2
                | Basic Information
              .space-y-3.text-sm
                div
                  span.font-medium.text-gray-600 Transaction ID:
                  p.text-gray-900.font-mono.break-all= transaction.transaction_id
                div
                  span.font-medium.text-gray-600 Case ID:
                  p.text-gray-900 ##{transaction.case_id}
                div
                  span.font-medium.text-gray-600 Payment Method:
                  p.text-gray-900.uppercase.font-semibold= transaction.payment_method
                div
                  span.font-medium.text-gray-600 Created:
                  p.text-gray-900= formatDate(transaction.created_at)
                div
                  span.font-medium.text-gray-600 Last Updated:
                  p.text-gray-900= formatDate(transaction.updated_at)

            // Financial Details
            .bg-gray-50.rounded-lg.p-6
              h2.text-lg.font-semibold.text-gray-800.mb-4
                i.fas.fa-dollar-sign.mr-2
                | Financial Breakdown
              .space-y-3.text-sm
                div
                  span.font-medium.text-gray-600 Total Amount:
                  p.text-gray-900.font-bold.text-lg= formatCurrency(transaction.total_amount)
                div
                  span.font-medium.text-gray-600 Admin Commission (10%):
                  p.text-gray-900.font-semibold= formatCurrency(transaction.commission_amount || (transaction.total_amount * 0.1))
                div
                  span.font-medium.text-gray-600 Craftsman Amount (90%):
                  p.text-gray-900.font-semibold= formatCurrency(transaction.disbursement_amount || (transaction.total_amount * 0.9))
                if transaction.payment_reference
                  div
                    span.font-medium.text-gray-600 Payment Reference:
                    p.text-gray-900.font-mono= transaction.payment_reference
                if transaction.disbursement_reference
                  div
                    span.font-medium.text-gray-600 Disbursement Reference:
                    p.text-gray-900.font-mono= transaction.disbursement_reference

          // Contact Information
          .bg-gray-50.rounded-lg.p-6.mb-8
            h2.text-lg.font-semibold.text-gray-800.mb-4
              i.fas.fa-users.mr-2
              | Contact Information
            .grid.grid-cols-1.md:grid-cols-2.gap-6.text-sm
              div
                span.font-medium.text-gray-600 Employer Phone:
                p.text-gray-900.font-semibold= transaction.employer_phone
              div
                span.font-medium.text-gray-600 Craftsman Phone:
                p.text-gray-900.font-semibold= transaction.craftsman_phone

          // Activity Timeline
          if logs && logs.length > 0
            .bg-gray-50.rounded-lg.p-6.mb-8
              h2.text-lg.font-semibold.text-gray-800.mb-4
                i.fas.fa-history.mr-2
                | Activity Timeline
              .space-y-4
                each log in logs
                  .flex.items-start.space-x-4.p-4.bg-white.rounded-lg.border
                    case log.status
                      when 'SUCCESSFUL'
                        .w-8.h-8.bg-green-100.rounded-full.flex.items-center.justify-center.flex-shrink-0
                          i.fas.fa-check.text-green-600.text-sm
                      when 'FAILED'
                        .w-8.h-8.bg-red-100.rounded-full.flex.items-center.justify-center.flex-shrink-0
                          i.fas.fa-times.text-red-600.text-sm
                      when 'INITIATED'
                        .w-8.h-8.bg-blue-100.rounded-full.flex.items-center.justify-center.flex-shrink-0
                          i.fas.fa-play.text-blue-600.text-sm
                      default
                        .w-8.h-8.bg-gray-100.rounded-full.flex.items-center.justify-center.flex-shrink-0
                          i.fas.fa-circle.text-gray-600.text-sm
                    div.flex-1
                      .flex.items-center.justify-between.mb-1
                        h3.font-medium.text-gray-900= log.action.replace(/_/g, ' ')
                        span.text-xs.text-gray-500= formatDate(log.created_at)
                      p.text-sm.text-gray-600.capitalize= log.status.toLowerCase()
                      if log.error_message
                        p.text-sm.text-red-600.mt-2.bg-red-50.p-2.rounded= log.error_message

          // Actions
          .flex.flex-col.sm:flex-row.gap-4
            a(href='/admin/dashboard').flex.items-center.justify-center.px-6.py-3.bg-gray-100.text-gray-700.font-medium.rounded-lg.hover:bg-gray-200.transition-all
              i.fas.fa-arrow-left.mr-2
              | Back to Dashboard
            
            // NEW: Show "Release Funds" button if the transaction is 'SUCCESSFUL'
            if transaction.status === 'SUCCESSFUL'
              form(action=`/payment/disburse/${transaction.transaction_id}`, method="POST")
                input(type='hidden' name='paymentMethod' value=transaction.payment_method)
                button.flex.items-center.justify-center.px-6.py-3.btn-primary.text-white.font-medium.rounded-lg(type='submit')
                  i.fas.fa-paper-plane.mr-2
                  | Release Funds to Craftsman